# ==============================
# Deployment Code-Server + kubectl
# ==============================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: code-server
  labels:
    app: code-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: code-server
  template:
    metadata:
      labels:
        app: code-server
    spec:
      serviceAccountName: code-server-sa  # <-- ServiceAccount để kubectl truy cập cluster
      securityContext:
        fsGroup: 1000
        runAsUser: 1000
      containers:
      - name: code-server
        image: codercom/code-server:latest
        args: ["--bind-addr", "0.0.0.0:8080"]
        ports:
        - containerPort: 8080
        env:
        - name: PASSWORD
          value: "123456" # Thay bằng mật khẩu mạnh
        volumeMounts:
        - name: code-volume
          mountPath: /home/coder
        - name: kubernetes-token
          mountPath: /var/run/secrets/kubernetes.io/serviceaccount
          readOnly: true
        lifecycle:
          postStart:
            exec:
              command:
                - sh
                - -c
                - |
                  echo "Installing kubectl..."
                  curl -LO "https://dl.k8s.io/release/$(curl -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
                  chmod +x kubectl
                  mv kubectl /usr/local/bin/
      volumes:
      - name: code-volume
        persistentVolumeClaim:
          claimName: code-server-pvc
      - name: kubernetes-token
        projected:
          sources:
          - serviceAccountToken:
              path: token
              expirationSeconds: 3600

---
# ==============================
# Service để truy cập Code-Server
# ==============================
apiVersion: v1
kind: Service
metadata:
  name: code-server-service
spec:
  selector:
    app: code-server
  type: LoadBalancer
  ports:
    - protocol: TCP
      port: 33080       # Port public
      targetPort: 8080  # Port container

---
# ==============================
# PVC lưu dữ liệu Code-Server
# ==============================
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: code-server-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi

---
# ==============================
# ServiceAccount cho kubectl
# ==============================
apiVersion: v1
kind: ServiceAccount
metadata:
  name: code-server-sa
---
# ClusterRoleBinding để grant quyền cluster-admin
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: code-server-crb
subjects:
- kind: ServiceAccount
  name: code-server-sa
  namespace: default
roleRef:
  kind: ClusterRole
  name: cluster-admin
  apiGroup: rbac.authorization.k8s.io
